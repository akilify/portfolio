// ========== CORE FUNCTIONALITY ==========
document.addEventListener('DOMContentLoaded', function() {
  // Hide loading spinner immediately
  const loadingSpinner = document.getElementById('loadingSpinner');
  if (loadingSpinner) {
    loadingSpinner.classList.add('hidden');
  }
  
  // Set current year
  const currentYearEl = document.getElementById('currentYear');
  if (currentYearEl) {
    currentYearEl.textContent = new Date().getFullYear();
  }
  
  initializeTheme();
  initializeProjects();
  initializeStats();
  initializeModal();
  initializeCopyEmail();
  initializeSmoothScroll();
  initializeBackToTop();
  initializeNewsletter();
  initializeMobileCarousel();
  
  console.log('âœ… Portfolio loaded successfully!');
});

// ========== THEME TOGGLE ==========
function initializeTheme() {
  const themeToggle = document.getElementById('themeToggle');
  if (!themeToggle) return;
  
  const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
  const currentTheme = localStorage.getItem('theme') || 
                      (prefersDarkScheme.matches ? 'dark' : 'light');
  
  document.documentElement.setAttribute('data-theme', currentTheme);
  updateThemeIcon(currentTheme);
  
  themeToggle.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
  });
  
  function updateThemeIcon(theme) {
    themeToggle.innerHTML = theme === 'dark' ? 
      '<i class="fas fa-sun"></i>' : 
      '<i class="fas fa-moon"></i>';
  }
}

// ========== PROJECT FILTERING ==========
function initializeProjects() {
  const filterButtons = document.querySelectorAll('.filter-btn');
  const projects = document.querySelectorAll('.project');
  
  if (!filterButtons.length || !projects.length) return;
  
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Update active button
      filterButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      
      const filter = button.getAttribute('data-filter');
      
      // Filter projects
      projects.forEach(project => {
        const categories = project.getAttribute('data-categories');
        
        if (filter === 'all' || categories.includes(filter)) {
          project.style.display = 'flex';
          setTimeout(() => {
            project.style.opacity = '1';
            project.style.transform = 'translateY(0)';
          }, 10);
        } else {
          project.style.opacity = '0';
          project.style.transform = 'translateY(20px)';
          setTimeout(() => {
            project.style.display = 'none';
          }, 300);
        }
      });
    });
  });
}

// ========== ANIMATED STATS ==========
function initializeStats() {
  const stats = document.querySelectorAll('.stat-number');
  if (!stats.length) return;
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const stat = entry.target;
        const target = parseInt(stat.getAttribute('data-count'));
        const duration = 1500;
        const increment = target / (duration / 16);
        let current = 0;
        
        const timer = setInterval(() => {
          current += increment;
          if (current >= target) {
            stat.textContent = target;
            clearInterval(timer);
          } else {
            stat.textContent = Math.floor(current);
          }
        }, 16);
        
        observer.unobserve(stat);
      }
    });
  }, { threshold: 0.5 });
  
  stats.forEach(stat => observer.observe(stat));
}

// ========== MODAL ==========
function initializeModal() {
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const modalImage = document.getElementById('modalImage');
  const modalBadges = document.getElementById('modalBadges');
  const modalLive = document.getElementById('modalLive');
  const modalCode = document.getElementById('modalCode');
  const closeBtn = document.getElementById('closeBtn');
  const readMoreBtn = document.getElementById('readMoreBtn');
  
  if (!modal) return;
  
  // Project data
  const projectsData = {
    akilify: {
      title: "Akilify - AI-Powered Learning Platform",
      description: "Akilify is an AI-integrated e-learning ecosystem designed to make quality education accessible across Africa.",
      badges: ["React", "Node.js", "TensorFlow.js", "MongoDB", "Tailwind CSS", "PWA"],
      liveUrl: "https://akilify.com",
      codeUrl: "https://github.com/johnmukuwa/akilify",
      image: "https://images.unsplash.com/photo-1521702817358-3540b6b9f1d2?w=1600&q=80&auto=format&fit=crop"
    },
    verseelite: {
      title: "VerseELITE - Poetry Platform for Creators",
      description: "VerseELITE empowers African poets to publish, build audiences, and monetize their work.",
      badges: ["Next.js", "Stripe", "PostgreSQL", "TypeScript", "AWS S3", "Prisma"],
      liveUrl: "https://verseelite.com",
      codeUrl: "https://github.com/johnmukuwa/verseelite",
      image: "https://images.unsplash.com/photo-1496483353456-90997957cf99?w=1600&q=80&auto=format&fit=crop"
    }
  };
  
  // Project click handlers
  document.querySelectorAll('.project').forEach(project => {
    project.addEventListener('click', function(e) {
      // Don't open modal if clicking buttons
      if (e.target.closest('.overlay') || e.target.closest('a')) {
        return;
      }
      
      const projectId = this.getAttribute('data-project');
      const projectData = projectsData[projectId];
      
      if (projectData) {
        openModal(projectData);
      }
    });
  });
  
  function openModal(project) {
    modalTitle.textContent = project.title;
    
    const shortDesc = modalDesc.querySelector('.short-desc');
    const fullDesc = modalDesc.querySelector('.full-desc');
    shortDesc.textContent = project.description;
    fullDesc.textContent = project.description;
    fullDesc.style.display = 'none';
    readMoreBtn.textContent = 'Read More';
    
    modalImage.style.backgroundImage = `url('${project.image}')`;
    modalLive.href = project.liveUrl;
    modalCode.href = project.codeUrl;
    
    // Update button text based on URL type
    if (project.liveUrl === '#') {
      modalLive.innerHTML = '<i class="fas fa-file-alt"></i> Case Study';
    } else if (project.liveUrl.includes('wa.me')) {
      modalLive.innerHTML = '<i class="fab fa-whatsapp"></i> Try on WhatsApp';
    } else {
      modalLive.innerHTML = '<i class="fas fa-external-link-alt"></i> Live Demo';
    }
    
    // Clear and add badges
    modalBadges.innerHTML = '';
    project.badges.forEach(badge => {
      const badgeEl = document.createElement('span');
      badgeEl.className = 'modal-badge';
      badgeEl.textContent = badge;
      modalBadges.appendChild(badgeEl);
    });
    
    // Show modal
    modal.classList.add('open');
    document.body.classList.add('modal-open');
    document.body.style.overflow = 'hidden';
  }
  
  // Read More toggle
  readMoreBtn.addEventListener('click', () => {
    const fullDesc = modalDesc.querySelector('.full-desc');
    const shortDesc = modalDesc.querySelector('.short-desc');
    
    if (fullDesc.style.display === 'none') {
      fullDesc.style.display = 'block';
      shortDesc.style.display = 'none';
      readMoreBtn.textContent = 'Read Less';
    } else {
      fullDesc.style.display = 'none';
      shortDesc.style.display = 'block';
      readMoreBtn.textContent = 'Read More';
    }
  });
  
  // Close modal
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeModal();
  });
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.classList.contains('open')) {
      closeModal();
    }
  });
  
  function closeModal() {
    modal.classList.remove('open');
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
  }
}

// ========== COPY EMAIL ==========
function initializeCopyEmail() {
  const copyEmailBtn = document.querySelector('.copy-email-btn');
  const copyNotification = document.getElementById('copyNotification');
  
  if (!copyEmailBtn) return;
  
  copyEmailBtn.addEventListener('click', () => {
    navigator.clipboard.writeText('mukuwa47@gmail.com').then(() => {
      copyNotification.classList.add('show');
      
      setTimeout(() => {
        copyNotification.classList.remove('show');
      }, 3000);
    });
  });
}

// ========== SMOOTH SCROLL ==========
function initializeSmoothScroll() {
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      if (href === '#' || href === '#!') return;
      
      e.preventDefault();
      const targetElement = document.querySelector(href);
      
      if (targetElement) {
        const headerHeight = document.querySelector('header').offsetHeight;
        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight - 20;
        
        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
      }
    });
  });
}

// ========== BACK TO TOP ==========
function initializeBackToTop() {
  const backToTopBtn = document.querySelector('.back-to-top');
  if (!backToTopBtn) return;
  
  window.addEventListener('scroll', function() {
    if (window.scrollY > 500) {
      backToTopBtn.style.display = 'flex';
    } else {
      backToTopBtn.style.display = 'none';
    }
  });
  
  backToTopBtn.addEventListener('click', function(e) {
    e.preventDefault();
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  });
}

// ========== NEWSLETTER ==========
function initializeNewsletter() {
  const newsletterForm = document.getElementById('newsletterForm');
  if (!newsletterForm) return;
  
  newsletterForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const email = this.querySelector('input').value;
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = 'copy-notification';
    notification.textContent = 'Thanks for subscribing!';
    notification.style.background = 'var(--accent-gradient)';
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 10);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, 3000);
    
    this.reset();
  });
}

// ========== MOBILE CAROUSEL ==========
function initializeMobileCarousel() {
  if (window.innerWidth <= 768) {
    const projectsGrid = document.querySelector('.projects-grid');
    if (projectsGrid) {
      projectsGrid.classList.add('carousel');
    }
  }
}

// ========== CHART.JS ==========
// Initialize chart when the skills chart container is in view
const skillsChartContainer = document.querySelector('.skills-chart-container');
if (skillsChartContainer) {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        initializeSkillsChart();
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });
  
  observer.observe(skillsChartContainer);
}

function initializeSkillsChart() {
  const ctx = document.getElementById('skillsChart');
  if (!ctx) return;
  
  new Chart(ctx, {
    type: 'radar',
    data: {
      labels: ['Frontend', 'Backend', 'UI/UX', 'Healthcare', 'Product', 'Leadership'],
      datasets: [{
        label: 'Proficiency Level',
        data: [90, 85, 80, 95, 85, 75],
        backgroundColor: 'rgba(37, 99, 235, 0.2)',
        borderColor: 'rgba(37, 99, 235, 1)',
        borderWidth: 2,
        pointBackgroundColor: 'rgba(37, 99, 235, 1)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgba(37, 99, 235, 1)'
      }]
    },
    options: {
      scales: {
        r: {
          angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
          grid: { color: 'rgba(255, 255, 255, 0.1)' },
          pointLabels: { color: 'var(--muted)' },
          ticks: {
            color: 'var(--muted)',
            backdropColor: 'transparent',
            beginAtZero: true,
            max: 100
          }
        }
      },
      plugins: {
        legend: {
          labels: { color: 'var(--fg)' }
        }
      }
    }
  });
}